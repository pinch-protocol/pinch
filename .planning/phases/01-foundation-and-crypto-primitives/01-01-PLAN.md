---
phase: 01-foundation-and-crypto-primitives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pnpm-workspace.yaml
  - buf.yaml
  - buf.gen.yaml
  - go.work
  - relay/go.mod
  - relay/go.sum
  - relay/cmd/pinchd/main.go
  - skill/package.json
  - skill/tsconfig.json
  - gen/ts/package.json
  - proto/pinch/v1/envelope.proto
  - gen/go/pinch/v1/envelope.pb.go
  - gen/ts/pinch/v1/envelope_pb.ts
  - .github/workflows/ci.yml
  - biome.json
  - .gitignore
autonomous: true
requirements:
  - PROT-01
  - PROT-02
  - PROT-03
  - PROT-04

must_haves:
  truths:
    - "Proto schema defines Envelope with version field, MessageType enum, oneof payload, EncryptedPayload with nonce + ciphertext, PlaintextPayload with sequence + timestamp"
    - "buf generate produces Go code in gen/go/ and TypeScript code in gen/ts/ from shared proto files"
    - "Go relay module can import generated protobuf types and compile"
    - "TypeScript skill can import generated protobuf types as @pinch/proto workspace dependency"
    - "CI runs Go tests, TypeScript tests, and linting on push"
  artifacts:
    - path: "proto/pinch/v1/envelope.proto"
      provides: "Shared protobuf schema with Envelope, EncryptedPayload, PlaintextPayload, MessageType enum"
      contains: "package pinch.v1"
    - path: "gen/go/pinch/v1/envelope.pb.go"
      provides: "Generated Go protobuf code"
      contains: "type Envelope struct"
    - path: "gen/ts/pinch/v1/envelope_pb.ts"
      provides: "Generated TypeScript protobuf code"
      contains: "Envelope"
    - path: "relay/go.mod"
      provides: "Go module definition for relay"
      contains: "module github.com/pinch-protocol/pinch/relay"
    - path: "skill/package.json"
      provides: "TypeScript skill package with workspace dependency on @pinch/proto"
      contains: "@pinch/proto"
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI matrix for Go + TypeScript"
      contains: "go test"
  key_links:
    - from: "relay/go.mod"
      to: "gen/go/pinch/v1/envelope.pb.go"
      via: "go.work workspace"
      pattern: "go.work.*use.*gen/go"
    - from: "skill/package.json"
      to: "gen/ts/package.json"
      via: "pnpm workspace dependency"
      pattern: "@pinch/proto.*workspace"
    - from: "buf.gen.yaml"
      to: "proto/pinch/v1/envelope.proto"
      via: "buf generate input"
      pattern: "directory: proto"
---

<objective>
Scaffold the Pinch monorepo with Go relay module, TypeScript skill package, pnpm workspace, buf protobuf toolchain, and the complete proto schema for the v1 wire format. Generate Go and TypeScript code from the proto schema and verify cross-language compilation.

Purpose: Establish the shared foundation (proto schema + generated code + monorepo wiring) that all subsequent plans depend on. Without working protobuf codegen and monorepo imports, nothing else can build.
Output: Working monorepo where `buf generate` produces code both Go and TypeScript can import, CI pipeline runs tests and linting.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-crypto-primitives/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold monorepo structure with Go module, TypeScript workspace, and buf configuration</name>
  <files>
    pnpm-workspace.yaml
    buf.yaml
    buf.gen.yaml
    go.work
    relay/go.mod
    relay/cmd/pinchd/main.go
    skill/package.json
    skill/tsconfig.json
    skill/src/index.ts
    gen/ts/package.json
    gen/go/go.mod
    biome.json
    .gitignore
    .github/workflows/ci.yml
  </files>
  <action>
    Create the monorepo directory structure per the research recommendation:

    ```
    pinch/
      relay/           # Go relay server
        cmd/pinchd/    # Binary entry point (stub main.go with "Hello Pinch relay")
        internal/      # Empty dirs for hub, protocol, crypto (created by later plans)
      skill/           # TypeScript OpenClaw skill
        src/
          index.ts     # Stub export
      proto/           # Shared .proto files
      gen/
        go/            # Generated Go protobuf code
        ts/            # Generated TypeScript protobuf code (workspace package)
    ```

    **Go setup:**
    - `relay/go.mod`: `module github.com/pinch-protocol/pinch/relay` with Go 1.22+
    - `gen/go/go.mod`: `module github.com/pinch-protocol/pinch/gen/go` with protobuf runtime dependency
    - `go.work` at repo root: `use (./relay, ./gen/go)`
    - `relay/cmd/pinchd/main.go`: minimal main() that prints "pinch relay" and exits (placeholder)
    - Run `go mod tidy` in both relay/ and gen/go/

    **TypeScript setup:**
    - `skill/package.json`: name `@pinch/skill`, type `module`, dependency on `@pinch/proto: "workspace:*"`, devDeps: `typescript`, `vitest`, `@biomejs/biome`, `@types/ws`
    - `skill/tsconfig.json`: strict mode, ESNext target, NodeNext module resolution
    - `gen/ts/package.json`: name `@pinch/proto`, type `module`, dependency on `@bufbuild/protobuf@^2.11.0`
    - `pnpm-workspace.yaml`: packages `['skill', 'gen/ts']`
    - Run `pnpm install` from repo root

    **Biome config:**
    - `biome.json` at repo root with recommended preset, organizeImports enabled

    **buf config:**
    - `buf.yaml` at repo root: version v2, modules path `proto`, DEFAULT lint, FILE breaking
    - `buf.gen.yaml` at repo root: version v2, clean true, managed enabled, plugins for `buf.build/protocolbuffers/go` (out: gen/go, opt: paths=source_relative) and `buf.build/bufbuild/protobuf-es` (out: gen/ts, opt: target=ts)

    **CI:**
    - `.github/workflows/ci.yml`: GitHub Actions workflow with matrix:
      - Go job: checkout, setup Go 1.22+, install golangci-lint, `go build ./...` in relay/, `go test ./...` in relay/, golangci-lint run in relay/
      - TypeScript job: checkout, setup Node 20+, setup pnpm, `pnpm install`, `pnpm -r biome check`, `pnpm -C skill test`
      - Both jobs triggered on push and pull_request to main

    **.gitignore:** node_modules/, dist/, *.exe, .env, coverage/

    Do NOT install runtime dependencies yet (ws, libsodium, etc.) -- those come in Plans 02 and 03 where they are actually used.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && go build ./relay/cmd/pinchd/ && pnpm -C skill exec tsc --noEmit</automated>
    <manual>Verify directory structure matches the layout above</manual>
  </verify>
  <done>Go relay compiles, TypeScript skill compiles, pnpm workspace resolves @pinch/proto, go.work links relay to gen/go, buf.yaml and buf.gen.yaml exist</done>
</task>

<task type="auto">
  <name>Task 2: Define protobuf schema and generate cross-language code</name>
  <files>
    proto/pinch/v1/envelope.proto
    gen/go/pinch/v1/envelope.pb.go
    gen/ts/pinch/v1/envelope_pb.ts
    relay/internal/protocol/proto_test.go
    skill/src/proto.test.ts
  </files>
  <action>
    **Proto schema** (`proto/pinch/v1/envelope.proto`):
    Define the complete v1 wire format per RESEARCH.md Section 2:

    - `package pinch.v1;`
    - `enum MessageType` with: UNSPECIFIED=0, HANDSHAKE=1, AUTH_CHALLENGE=2, AUTH_RESPONSE=3, MESSAGE=4, DELIVERY_CONFIRM=5, CONNECTION_REQUEST=6, CONNECTION_RESPONSE=7, HEARTBEAT=8
    - `message Envelope` with: uint32 version=1, string from_address=2, string to_address=3, MessageType type=4, bytes message_id=5, int64 timestamp=6, oneof payload { EncryptedPayload encrypted=10, Handshake handshake=11, Heartbeat heartbeat=12 }
    - `message EncryptedPayload` with: bytes nonce=1, bytes ciphertext=2, bytes sender_public_key=3
    - `message PlaintextPayload` with: uint32 version=1, uint64 sequence=2, int64 timestamp=3, bytes content=4, string content_type=5
    - `message Handshake` with: uint32 version=1, bytes signing_key=2, bytes encryption_key=3
    - `message Heartbeat` with: int64 timestamp=1

    Per user decision: sequence and timestamp are INSIDE PlaintextPayload (encrypted), NOT in the cleartext Envelope. The Envelope.timestamp is relay-level only (untrusted).

    **Code generation:**
    - Install buf CLI if not present: `npm install -g @bufbuild/buf` or use npx
    - Run `buf generate` from repo root
    - Verify gen/go/pinch/v1/envelope.pb.go and gen/ts/pinch/v1/envelope_pb.ts are created
    - Run `buf lint` to validate schema

    **Serialization tests:**

    Go test (`relay/internal/protocol/proto_test.go`):
    - Create an Envelope with all fields populated (version=1, from/to addresses, MessageType MESSAGE, message_id, timestamp, EncryptedPayload with dummy nonce/ciphertext/sender_public_key)
    - Serialize with proto.Marshal, deserialize with proto.Unmarshal
    - Verify all fields round-trip correctly
    - Create a PlaintextPayload with version=1, sequence=42, timestamp=now, content=[]byte("hello"), content_type="text/plain"
    - Verify serialization round-trip

    TypeScript test (`skill/src/proto.test.ts`):
    - Same tests: create Envelope, serialize with toBinary(), deserialize with fromBinary()
    - Verify all fields including oneof payload discrimination
    - Create PlaintextPayload, verify round-trip
    - Test that MessageType enum values match expected integers

    Both test suites must pass independently.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && buf lint && go test ./relay/internal/protocol/... && pnpm -C skill test</automated>
  </verify>
  <done>Proto schema passes buf lint, Go serialization tests pass, TypeScript serialization tests pass, both can create and round-trip Envelope and PlaintextPayload messages with all fields including version, sequence, timestamp</done>
</task>

</tasks>

<verification>
1. `buf lint` passes with no errors
2. `buf generate` produces both Go and TypeScript code
3. `go build ./relay/cmd/pinchd/` succeeds
4. `pnpm -C skill exec tsc --noEmit` succeeds (TypeScript compiles)
5. `go test ./relay/internal/protocol/...` passes (proto serialization round-trip)
6. `pnpm -C skill test` passes (proto serialization round-trip)
7. CI workflow file exists at `.github/workflows/ci.yml`
</verification>

<success_criteria>
- Monorepo compiles in both Go and TypeScript
- Proto schema defines all message types per RESEARCH.md spec
- Generated code imports work in both languages via workspace/go.work wiring
- Serialization round-trip tests pass in both languages independently
- CI pipeline configuration exists for both languages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-crypto-primitives/01-01-SUMMARY.md`
</output>
