---
phase: 06-oversight-and-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skill/src/autonomy/activity-feed.ts
  - skill/src/autonomy/activity-feed.test.ts
  - skill/src/tools/pinch-activity.ts
  - skill/src/tools/pinch-activity.test.ts
  - skill/src/index.ts
autonomous: true
requirements:
  - OVRS-01
  - OVRS-02
  - OVRS-05
  - OVRS-06

must_haves:
  truths:
    - "Activity feed records all event types (messages, connections, autonomy changes, permission updates) with hash chaining"
    - "Activity feed is filterable by connection, time range, and event type"
    - "Each event entry includes timestamp, actor pubkey, action type, connection ID, message hash, and a SHA-256 hash chain linking to the previous entry"
    - "The pinch_activity tool queries the unified event log and returns structured JSON results, excluding muted events by default"
  artifacts:
    - path: "skill/src/autonomy/activity-feed.ts"
      provides: "Evolved ActivityFeed with OVRS-06 columns, hash chaining, time range filtering"
      contains: "computeEntryHash"
    - path: "skill/src/tools/pinch-activity.ts"
      provides: "CLI tool for querying the unified event log"
      exports: ["parseArgs", "run"]
  key_links:
    - from: "skill/src/autonomy/activity-feed.ts"
      to: "node:crypto"
      via: "createHash('sha256') for hash chain computation"
      pattern: "createHash.*sha256"
    - from: "skill/src/tools/pinch-activity.ts"
      to: "skill/src/autonomy/activity-feed.ts"
      via: "getEvents() with filter parameters"
      pattern: "activityFeed\\.getEvents"
---

<objective>
Evolve the existing ActivityFeed into a unified event log with SHA-256 hash chaining and build the `pinch_activity` query tool.

Purpose: Establishes the tamper-evident event log foundation that all other Phase 6 features depend on (audit verification, intervention logging, mute recording). Satisfies the user's locked decisions for a single append-only table for all event types with hash chaining.

Output: Evolved `activity-feed.ts` with OVRS-06 columns, hash chain computation, time range filtering; `pinch-activity.ts` CLI tool; passing tests.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-oversight-and-safety/06-CONTEXT.md
@.planning/phases/06-oversight-and-safety/06-RESEARCH.md
@skill/src/autonomy/activity-feed.ts
@skill/src/autonomy/activity-feed.test.ts
@skill/src/tools/cli.ts
@skill/src/tools/pinch-history.ts
@skill/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Evolve ActivityFeed schema with OVRS-06 columns and SHA-256 hash chaining</name>
  <files>
    skill/src/autonomy/activity-feed.ts
    skill/src/autonomy/activity-feed.test.ts
  </files>
  <action>
Evolve the existing `ActivityFeed` class in `skill/src/autonomy/activity-feed.ts`:

1. **Add new columns to schema.** In `initSchema()`, after the existing CREATE TABLE, use `ALTER TABLE ADD COLUMN` with `PRAGMA table_info` existence checks to add:
   - `actor_pubkey TEXT` -- who performed the action (Ed25519 pubkey, hex or base64)
   - `action_type TEXT` -- semantic action type (e.g., "message_send", "connection_approve", "autonomy_change")
   - `message_hash TEXT` -- SHA-256 hash of the message content (if applicable)
   - `prev_hash TEXT NOT NULL DEFAULT ''` -- hash of the previous entry in the chain
   - `entry_hash TEXT NOT NULL DEFAULT ''` -- SHA-256 hash of this entry's data + prev_hash

2. **Add a `created_at` range index** for time-based filtering: `CREATE INDEX IF NOT EXISTS idx_activity_events_created_range ON activity_events(created_at);`

3. **Add `computeEntryHash` function** using `node:crypto`:
   ```typescript
   import { createHash } from "node:crypto";
   function computeEntryHash(entry: { id: string; timestamp: string; actorPubkey: string; actionType: string; connectionAddress: string; messageHash: string; prevHash: string; }): string {
     const data = [entry.id, entry.timestamp, entry.actorPubkey, entry.actionType, entry.connectionAddress, entry.messageHash, entry.prevHash].join("|");
     return createHash("sha256").update(data).digest("hex");
   }
   ```
   Export `computeEntryHash` for use by the audit verification tool later.

4. **Evolve the `ActivityEvent` interface** to include optional fields: `actorPubkey?: string`, `actionType?: string`, `messageHash?: string`, `prevHash?: string`, `entryHash?: string`.

5. **Update the `record()` method:**
   - Accept the new optional fields (`actorPubkey`, `actionType`, `messageHash`) in the event parameter
   - Before INSERT, query the last entry's `entry_hash`: `SELECT entry_hash FROM activity_events ORDER BY created_at DESC, id DESC LIMIT 1`
   - Compute `entryHash` using `computeEntryHash({ id, timestamp: createdAt, actorPubkey: event.actorPubkey ?? "", actionType: event.actionType ?? event.eventType, connectionAddress: event.connectionAddress, messageHash: event.messageHash ?? "", prevHash })`
   - INSERT all fields including `actor_pubkey`, `action_type`, `message_hash`, `prev_hash`, `entry_hash`

6. **Update the `getEvents()` method** to support time range filtering and event type exclusion:
   - Add `since?: string` (ISO timestamp) and `until?: string` (ISO timestamp) to the options
   - Add `excludeEventTypes?: string[]` to the options -- when provided, add `WHERE event_type NOT IN (...)` clause to exclude those event types from results
   - Add SQL WHERE conditions: `created_at >= @since` and `created_at <= @until` when provided
   - Update `rowToEvent()` to map the new columns to the extended `ActivityEvent` interface

7. **Backward compatibility:** Existing callers that pass only the original fields (connectionAddress, eventType, messageId, badge, details) continue to work. New fields default to empty strings in hash computation. The first hash-chained entry is a "genesis" entry with `prevHash = ""` -- old entries without hashes are pre-audit.

**Tests in `activity-feed.test.ts`:**
   - Test that `record()` creates entries with non-empty `entryHash` and `prevHash` fields
   - Test hash chain integrity: record 3 events, verify each entry's `prevHash` matches the previous entry's `entryHash`
   - Test `computeEntryHash` produces consistent deterministic output
   - Test `getEvents({ since, until })` time range filtering returns correct subset
   - Test `getEvents({ connectionAddress, eventType })` existing filters still work
   - Test backward compatibility: `record()` without new fields still works (actorPubkey defaults to "")
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && npx vitest run skill/src/autonomy/activity-feed.test.ts</automated>
  </verify>
  <done>ActivityFeed records events with SHA-256 hash chaining. Each new entry has a computed entryHash linking to prevHash. Time range filtering works. All existing callers remain compatible.</done>
</task>

<task type="auto">
  <name>Task 2: Create pinch_activity skill tool for querying the unified event log</name>
  <files>
    skill/src/tools/pinch-activity.ts
    skill/src/tools/pinch-activity.test.ts
    skill/src/index.ts
  </files>
  <action>
Create `skill/src/tools/pinch-activity.ts` following the established CLI tool pattern (see `pinch-history.ts` and `pinch-send.ts`):

1. **CLI interface:**
   ```
   pinch-activity [--connection <address>] [--type <event_type>] [--since <ISO_timestamp>] [--until <ISO_timestamp>] [--limit <number>]
   ```
   All parameters are optional. When none provided, returns the most recent 50 events across all connections.

2. **`parseArgs(args: string[])` function** (exported for testability):
   - Parse `--connection`, `--type`, `--since`, `--until`, `--limit`, `--include-muted` from args
   - Default limit to 50
   - `--include-muted` is a boolean flag (no value) that defaults to false

3. **`run(args: string[])` function** (exported):
   - Call `bootstrap()` to get `activityFeed`
   - Call `activityFeed.getEvents({ connectionAddress, eventType, since, until, limit, excludeEventTypes })` where `excludeEventTypes` defaults to `["message_received_muted", "message_receive_muted"]` unless an `--include-muted` flag is passed.
   - This default exclusion honors the locked decision: "Muted messages are still recorded in the audit log for completeness, but not surfaced in the activity feed." The `--include-muted` flag overrides this for audit/debugging purposes.
   - Output JSON: `{ events: ActivityEvent[], count: number }`
   - Call `shutdown()`

4. **Self-executable entry point** (same pattern as other tools):
   ```typescript
   if (process.argv[1] && (process.argv[1].endsWith("pinch-activity.ts") || process.argv[1].endsWith("pinch-activity.js"))) {
     run(process.argv.slice(2)).catch(...)
   }
   ```

5. **Update `skill/src/index.ts`** -- no new exports needed for the tool itself (tools are CLI entry points, not library exports), but if any new types were added to activity-feed.ts, export them.

**Tests in `pinch-activity.test.ts`:**
   - Test `parseArgs` with various flag combinations
   - Test `parseArgs` with no flags returns defaults (limit: 50)
   - Test `parseArgs` with `--connection`, `--type`, `--since`, `--until`, `--limit`
   - Test `parseArgs` with `--include-muted` flag sets includeMuted to true
   - Test `parseArgs` without `--include-muted` defaults to false
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && npx vitest run skill/src/tools/pinch-activity.test.ts</automated>
  </verify>
  <done>The `pinch_activity` skill tool exists, parses CLI arguments, queries the unified event log with filter parameters, and outputs structured JSON results. Tests pass.</done>
</task>

</tasks>

<verification>
1. All existing activity-feed tests continue to pass (backward compatibility)
2. New hash chain tests verify tamper-evident integrity
3. Time range filtering returns correct event subsets
4. `pinch_activity` tool parses arguments and queries correctly
5. `npx vitest run skill/src/autonomy/ skill/src/tools/pinch-activity` -- all green
</verification>

<success_criteria>
- ActivityFeed schema includes OVRS-06 fields (actor_pubkey, action_type, message_hash, prev_hash, entry_hash)
- SHA-256 hash chaining computed on every record() call
- getEvents() supports since/until time range filtering
- pinch_activity CLI tool functional with all filter parameters
- Zero regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-oversight-and-safety/06-01-SUMMARY.md`
</output>
