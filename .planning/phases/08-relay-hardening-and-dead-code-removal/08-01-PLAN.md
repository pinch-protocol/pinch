---
phase: 08-relay-hardening-and-dead-code-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - relay/internal/hub/client.go
  - relay/internal/hub/hub.go
  - relay/cmd/pinchd/main.go
autonomous: true
requirements:
  - RELY-06

must_haves:
  truths:
    - "TrackFlushKey and PopFlushKey methods do not exist in the compiled relay binary"
    - "The relay compiles and all existing tests pass after dead code removal"
    - "InsecureSkipVerify is false by default when PINCH_RELAY_DEV is unset"
    - "InsecureSkipVerify is true when PINCH_RELAY_DEV=1 is set"
    - "Test-file InsecureSkipVerify usage (hub_test.go) is unchanged"
  artifacts:
    - path: "relay/internal/hub/client.go"
      provides: "Client struct without dead flush key fields and methods"
      contains: "flushing atomic.Bool"
    - path: "relay/internal/hub/hub.go"
      provides: "RouteMessage without delivery-confirm flush correlation block"
      contains: "RouteMessage"
    - path: "relay/cmd/pinchd/main.go"
      provides: "PINCH_RELAY_DEV env var gating InsecureSkipVerify"
      contains: "PINCH_RELAY_DEV"
  key_links:
    - from: "relay/cmd/pinchd/main.go"
      to: "wsHandler"
      via: "devMode bool parameter threaded from main to wsHandler closure"
      pattern: "wsHandler.*devMode"
---

<objective>
Remove dead TrackFlushKey/PopFlushKey code from the relay hub and gate InsecureSkipVerify behind a PINCH_RELAY_DEV environment variable so production defaults to secure WebSocket origin verification.

Purpose: Eliminate dead code from a superseded delivery-confirm deletion strategy (Phase 4 decision [04-02]) and lock down a development convenience that must not ship as a hardcoded default.
Output: A cleaner relay codebase with no dead flush key code and environment-gated origin verification.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-relay-hardening-and-dead-code-removal/08-RESEARCH.md
@relay/internal/hub/client.go
@relay/internal/hub/hub.go
@relay/cmd/pinchd/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead TrackFlushKey/PopFlushKey code from client.go and hub.go</name>
  <files>relay/internal/hub/client.go, relay/internal/hub/hub.go</files>
  <action>
In `relay/internal/hub/client.go`:
1. Remove the `flushKeys map[string][]byte` field (line 50) and `flushMu sync.Mutex` field (line 51) from the `Client` struct
2. Remove the `TrackFlushKey()` method (lines 191-200) entirely
3. Remove the `PopFlushKey()` method (lines 202-214) entirely
4. Remove `"sync"` from the import block (line 7) -- it is ONLY used by `flushMu`. The `"sync/atomic"` import (line 8) MUST stay since `flushing atomic.Bool` uses it.

In `relay/internal/hub/hub.go`:
5. Remove the entire delivery-confirm flush correlation block (lines 267-284) -- the `if env.Type == pinchv1.MessageType_MESSAGE_TYPE_DELIVERY_CONFIRM { ... }` block. Delivery confirmations are still routed normally through the `switch` statement and `recipient.Send()` below -- they just no longer attempt the dead flush key correlation.
6. Remove `"encoding/hex"` from the import block (line 9) -- it is ONLY used by `hex.EncodeToString` in the removed block. The `"sync"` import in hub.go MUST stay because it is used by `mu sync.RWMutex` in the Hub struct.

KEEP the following (they share the "flush" naming but are actively used):
- `flushing atomic.Bool` field in Client struct
- `IsFlushing()` and `SetFlushing()` methods in client.go
- `flushQueuedMessages()` in hub.go
- `flushBatchSize` and `flushBatchDelay` constants in hub.go
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && go build ./relay/... && go test ./relay/... -count=1 -timeout 60s 2>&1 | tail -20</automated>
    <manual>Verify client.go has no flushKeys/flushMu fields and no TrackFlushKey/PopFlushKey methods; hub.go has no delivery-confirm correlation block</manual>
  </verify>
  <done>TrackFlushKey, PopFlushKey, flushKeys, flushMu, and the delivery-confirm correlation block are fully removed. The relay compiles and all existing tests pass. No active flush code (IsFlushing, SetFlushing, flushQueuedMessages) is affected.</done>
</task>

<task type="auto">
  <name>Task 2: Gate InsecureSkipVerify behind PINCH_RELAY_DEV environment variable</name>
  <files>relay/cmd/pinchd/main.go</files>
  <action>
In `relay/cmd/pinchd/main.go`:

1. In `main()`, after the existing env var reads (after the `rateBurst` block, before `ctx, stop := signal.NotifyContext`), add:
```go
devMode := os.Getenv("PINCH_RELAY_DEV") == "1"
if devMode {
    slog.Warn("development mode enabled: WebSocket origin verification disabled")
}
```

2. Change the `wsHandler` call on line 104 to pass `devMode`:
```go
r.Get("/ws", wsHandler(ctx, h, relayHost, devMode))
```

3. Change the `wsHandler` function signature (line 144) to accept `devMode bool`:
```go
func wsHandler(serverCtx context.Context, h *hub.Hub, relayHost string, devMode bool) http.HandlerFunc {
```

4. Change the `InsecureSkipVerify` value (line 148) from hardcoded `true` to `devMode`:
```go
conn, err := websocket.Accept(w, r, &websocket.AcceptOptions{
    InsecureSkipVerify: devMode,
})
```

5. Update the comment above it from "Allow connections from any origin in development." to "Allow connections from any origin when PINCH_RELAY_DEV=1."

DO NOT touch `relay/internal/hub/hub_test.go` -- the 6 occurrences of `InsecureSkipVerify: true` in test code are correct and must remain unchanged.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && go build ./relay/... && go test ./relay/... -count=1 -timeout 60s 2>&1 | tail -20</automated>
    <manual>Verify main.go reads PINCH_RELAY_DEV and threads devMode to wsHandler; InsecureSkipVerify uses devMode not hardcoded true</manual>
  </verify>
  <done>InsecureSkipVerify is gated behind PINCH_RELAY_DEV=1 env var. Production default (env unset) enforces WebSocket origin verification. Development mode logs a warning when enabled. Test files are untouched.</done>
</task>

</tasks>

<verification>
1. `go build ./relay/...` compiles without errors
2. `go test ./relay/... -count=1` passes all existing tests
3. `grep -r "TrackFlushKey\|PopFlushKey\|flushKeys\|flushMu" relay/internal/hub/client.go relay/internal/hub/hub.go` returns zero matches
4. `grep "InsecureSkipVerify: true" relay/cmd/pinchd/main.go` returns zero matches (moved to devMode variable)
5. `grep "InsecureSkipVerify: true" relay/internal/hub/hub_test.go` still returns matches (test code unchanged)
6. `grep "PINCH_RELAY_DEV" relay/cmd/pinchd/main.go` returns a match
</verification>

<success_criteria>
- Relay compiles and all tests pass
- No dead flush key code remains in client.go or hub.go
- InsecureSkipVerify defaults to false in production (PINCH_RELAY_DEV unset)
- InsecureSkipVerify is true only when PINCH_RELAY_DEV=1
- Test file InsecureSkipVerify usage is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-relay-hardening-and-dead-code-removal/08-01-SUMMARY.md`
</output>
