---
phase: 03-encrypted-1-1-messaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/pinch/v1/envelope.proto
  - gen/go/pinch/v1/envelope.pb.go
  - gen/ts/pinch/v1/envelope_pb.ts
  - relay/internal/hub/hub.go
  - relay/internal/hub/hub_test.go
autonomous: true
requirements: [CRYP-05, RELY-04]

must_haves:
  truths:
    - "DeliveryConfirm protobuf message exists with message_id, signature, timestamp, and state fields"
    - "Messages to online recipients use non-blocking channel dispatch (no blocking I/O in RouteMessage hot path)"
    - "Relay rejects messages exceeding 64KB with silent drop"
    - "Relay holds messages for offline recipients for up to 30 seconds before dropping"
  artifacts:
    - path: "proto/pinch/v1/envelope.proto"
      provides: "DeliveryConfirm message definition"
      contains: "message DeliveryConfirm"
    - path: "relay/internal/hub/hub.go"
      provides: "64KB size enforcement and 30-second transient buffer"
      contains: "maxEnvelopeSize"
  key_links:
    - from: "proto/pinch/v1/envelope.proto"
      to: "gen/go/pinch/v1/envelope.pb.go"
      via: "buf generate"
      pattern: "DeliveryConfirm"
    - from: "relay/internal/hub/hub.go"
      to: "relay/internal/hub/hub_test.go"
      via: "test coverage"
      pattern: "maxEnvelopeSize"
---

<objective>
Extend the protobuf schema with a DeliveryConfirm payload message and add relay-side message size enforcement (64KB limit) with a 30-second transient buffer for offline recipients.

Purpose: The DeliveryConfirm message is required for E2E signed delivery receipts (CRYP-05). The relay 64KB limit prevents abuse, and the 30-second buffer handles transient disconnects before Phase 4's full store-and-forward.
Output: Updated proto schema with generated Go/TS code, relay RouteMessage with size limit and transient buffer.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@proto/pinch/v1/envelope.proto
@relay/internal/hub/hub.go
@relay/internal/hub/hub_test.go
@relay/internal/hub/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DeliveryConfirm protobuf message and regenerate code</name>
  <files>proto/pinch/v1/envelope.proto, gen/go/pinch/v1/envelope.pb.go, gen/ts/pinch/v1/envelope_pb.ts</files>
  <action>
Add a DeliveryConfirm message to envelope.proto with the following fields:
- `bytes message_id = 1;` -- ID of the message being confirmed
- `bytes signature = 2;` -- Ed25519 detached signature of (message_id || timestamp)
- `int64 timestamp = 3;` -- confirmation timestamp
- `string state = 4;` -- delivery state (e.g., "delivered", "read_by_agent", "escalated_to_human")

Add to the Envelope oneof payload:
- `DeliveryConfirm delivery_confirm = 21;`

Run `buf generate` from the repo root to regenerate Go and TypeScript code. Verify generated files exist and contain the DeliveryConfirm type.

Use existing buf.gen.yaml config (clean:false per 01-01 decision to preserve go.mod/package.json in gen/ dirs).
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && buf lint proto && buf generate && grep -q "DeliveryConfirm" gen/go/pinch/v1/envelope.pb.go && grep -q "DeliveryConfirm" gen/ts/pinch/v1/envelope_pb.ts && echo "PASS"</automated>
  </verify>
  <done>DeliveryConfirm message defined in proto with message_id, signature, timestamp, and state fields. Generated Go and TypeScript code includes the new type. Envelope oneof includes delivery_confirm case.</done>
</task>

<task type="auto">
  <name>Task 2: Add relay 64KB size enforcement and 30-second transient buffer</name>
  <files>relay/internal/hub/hub.go, relay/internal/hub/hub_test.go</files>
  <action>
Modify hub.go RouteMessage to:

1. **64KB size limit**: Before any processing, check `len(envelope) > 65536`. If exceeded, log at debug level and return nil (silent drop, consistent with existing silent drop pattern for blocked/offline). Define `const maxEnvelopeSize = 65536` at package level.

2. **30-second transient buffer for offline recipients**: When recipient is not found via LookupClient, instead of immediately dropping, hold the message in a short-lived in-memory buffer:
   - Add a `pendingMessages` field to Hub: `map[string][]pendingMsg` where key is recipient address
   - `pendingMsg` struct: `data []byte, deadline time.Time`
   - On offline recipient: append to pendingMessages[toAddress] with deadline = now + 30s
   - Limit pending entries per address to 100 (prevent memory abuse)
   - On client registration (in Run's register case): flush any pending messages for the newly registered address via client.Send, then delete the entry
   - Add a cleanup goroutine in Run that periodically (every 10s) sweeps expired pending messages

Add tests in hub_test.go:
- Test that messages exceeding 64KB are silently dropped (construct an envelope larger than 65536 bytes, verify it does not reach recipient)
- Test that messages to offline recipients are delivered when recipient connects within 30 seconds
- Test that pending messages expire after 30 seconds (sleep or use a shorter test deadline)
- Test that pending queue is capped at 100 per address
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && go test ./relay/internal/hub/ -v -run "Test(MaxEnvelopeSize|PendingMessage|PendingExpir|PendingCap)" -count=1 2>&1 | tail -20</automated>
  </verify>
  <done>RouteMessage rejects envelopes exceeding 64KB. Offline recipients have messages buffered for 30 seconds. Buffer is flushed on reconnection. Expired messages are cleaned up. Per-address queue is capped.</done>
</task>

</tasks>

<verification>
- `buf lint proto` passes without errors
- `buf generate` produces updated Go and TypeScript code
- `go test ./relay/internal/hub/ -v` -- all existing tests pass plus new size/buffer tests
- `grep -q "DeliveryConfirm" gen/go/pinch/v1/envelope.pb.go` -- generated code includes new type
</verification>

<success_criteria>
- DeliveryConfirm protobuf message available in both Go and TypeScript generated code
- Relay enforces 64KB max envelope size at RouteMessage entry point
- Relay buffers messages for offline recipients for 30 seconds before dropping
- All Go relay tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-encrypted-1-1-messaging/03-01-SUMMARY.md`
</output>
