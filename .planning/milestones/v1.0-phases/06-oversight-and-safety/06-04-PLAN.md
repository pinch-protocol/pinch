---
phase: 06-oversight-and-safety
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - skill/src/tools/pinch-audit-verify.ts
  - skill/src/tools/pinch-audit-verify.test.ts
  - skill/src/tools/pinch-audit-export.ts
  - skill/src/tools/pinch-audit-export.test.ts
  - skill/src/index.ts
  - skill/SKILL.md
  - skill/HEARTBEAT.md
autonomous: true
requirements:
  - OVRS-05
  - OVRS-06

must_haves:
  truths:
    - "pinch_audit_verify walks the hash chain and reports pass/fail"
    - "pinch_audit_export dumps the audit log to a JSON file for independent verification"
    - "Bootstrap wires all new Phase 6 components correctly"
    - "SKILL.md documents all new tools (pinch_activity, pinch_intervene, pinch_mute, pinch_audit_verify, pinch_audit_export)"
    - "HEARTBEAT.md includes audit chain health check"
  artifacts:
    - path: "skill/src/tools/pinch-audit-verify.ts"
      provides: "CLI tool for verifying hash chain integrity"
      exports: ["parseArgs", "run"]
    - path: "skill/src/tools/pinch-audit-export.ts"
      provides: "CLI tool for exporting audit log to JSON"
      exports: ["parseArgs", "run"]
    - path: "skill/SKILL.md"
      provides: "Updated OpenClaw skill definition with Phase 6 tools"
      contains: "pinch_activity"
    - path: "skill/HEARTBEAT.md"
      provides: "Updated periodic checklist with audit chain verification"
      contains: "audit"
  key_links:
    - from: "skill/src/tools/pinch-audit-verify.ts"
      to: "skill/src/autonomy/activity-feed.ts"
      via: "computeEntryHash for chain verification"
      pattern: "computeEntryHash"
    - from: "skill/src/tools/pinch-audit-export.ts"
      to: "activity_events table"
      via: "SQL SELECT all hash-chained entries"
      pattern: "SELECT.*activity_events"
---

<objective>
Build audit verification and export tools, update bootstrap wiring, and update SKILL.md/HEARTBEAT.md for Phase 6 completion.

Purpose: Completes the tamper-evident audit system (OVRS-05, OVRS-06) with verification tools that prove integrity of the hash chain. Updates skill documentation to reflect all new Phase 6 capabilities. This is the final plan that brings all Phase 6 components together.

Output: `pinch-audit-verify.ts` and `pinch-audit-export.ts` CLI tools, updated `cli.ts` bootstrap, updated `SKILL.md` and `HEARTBEAT.md`, passing tests.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-oversight-and-safety/06-CONTEXT.md
@.planning/phases/06-oversight-and-safety/06-RESEARCH.md
@.planning/phases/06-oversight-and-safety/06-01-SUMMARY.md
@skill/src/autonomy/activity-feed.ts
@skill/src/tools/cli.ts
@skill/src/index.ts
@skill/SKILL.md
@skill/HEARTBEAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pinch_audit_verify and pinch_audit_export tools</name>
  <files>
    skill/src/tools/pinch-audit-verify.ts
    skill/src/tools/pinch-audit-verify.test.ts
    skill/src/tools/pinch-audit-export.ts
    skill/src/tools/pinch-audit-export.test.ts
  </files>
  <action>
**Step 1: Create `skill/src/tools/pinch-audit-verify.ts`:**

CLI interface:
```
pinch-audit-verify [--tail <N>]   # Verify hash chain integrity (optionally only last N entries)
```

Implementation:

1. `parseArgs(args)` -- parse optional `--tail` (number of recent entries to verify; default: all)

2. `run(args)`:
   - Call `bootstrap()` to get access to the SQLite database via `messageStore.getDb()`
   - Query all hash-chained entries (where `entry_hash != ''`) ordered by `created_at ASC, id ASC`
   - If `--tail N`, only query the last N entries
   - Walk the chain: for each entry, compute the expected hash using `computeEntryHash` (imported from `activity-feed.ts`) and compare with stored `entry_hash`
   - Also verify `prev_hash` matches the previous entry's `entry_hash`
   - The first hash-chained entry is the genesis (its `prev_hash` should be `""`)
   - Output JSON result:
     ```json
     {
       "valid": true,
       "total_entries": 1234,
       "verified_entries": 1234,
       "genesis_id": "...",
       "latest_id": "..."
     }
     ```
     On failure:
     ```json
     {
       "valid": false,
       "total_entries": 1234,
       "first_broken_at": "entry-id",
       "broken_index": 42,
       "expected_hash": "...",
       "actual_hash": "..."
     }
     ```
   - Call `shutdown()`

3. Self-executable entry point pattern.

**Step 2: Create `skill/src/tools/pinch-audit-export.ts`:**

CLI interface:
```
pinch-audit-export --output <path>   # Export audit log to JSON file
pinch-audit-export [--since <ISO>] [--until <ISO>] --output <path>   # Export with time range
```

Implementation:

1. `parseArgs(args)` -- parse `--output` (required), optional `--since`, `--until`

2. `run(args)`:
   - Call `bootstrap()` to get the SQLite database
   - Query `activity_events` with optional time range filters, ordered `created_at ASC, id ASC`
   - Build a JSON structure:
     ```json
     {
       "exported_at": "ISO timestamp",
       "total_entries": N,
       "entries": [
         {
           "id": "...",
           "connection_address": "...",
           "event_type": "...",
           "message_id": "...",
           "badge": "...",
           "details": "...",
           "created_at": "...",
           "actor_pubkey": "...",
           "action_type": "...",
           "message_hash": "...",
           "prev_hash": "...",
           "entry_hash": "..."
         }
       ]
     }
     ```
   - Write to the output file path using `writeFile`
   - Output JSON to stdout: `{ "exported": N, "path": "/path/to/export.json" }`
   - Call `shutdown()`

3. Self-executable entry point pattern.

**Step 3: Tests:**

`pinch-audit-verify.test.ts`:
- Test `parseArgs` with no args (verify all)
- Test `parseArgs` with `--tail 100`
- Test `parseArgs` with `--tail` missing number throws

`pinch-audit-export.test.ts`:
- Test `parseArgs` with `--output /tmp/audit.json`
- Test `parseArgs` with `--since`, `--until`, `--output`
- Test `parseArgs` throws when `--output` missing
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && npx vitest run skill/src/tools/pinch-audit-verify.test.ts skill/src/tools/pinch-audit-export.test.ts</automated>
  </verify>
  <done>pinch_audit_verify walks the SHA-256 hash chain and reports pass/fail with detailed output. pinch_audit_export dumps the full audit log to JSON for independent verification. Both tools handle optional parameters. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update bootstrap, SKILL.md, HEARTBEAT.md, and index.ts for Phase 6</name>
  <files>
    skill/src/index.ts
    skill/SKILL.md
    skill/HEARTBEAT.md
  </files>
  <action>
**Step 1: Verify `skill/src/tools/cli.ts` bootstrap wiring:**

Review the bootstrap function. The existing bootstrap already creates `activityFeed` from `messageStore.getDb()`. Since Phase 6 evolves the ActivityFeed in-place (same class, extended schema), no changes to bootstrap wiring should be needed -- the schema evolution happens in ActivityFeed's constructor `initSchema()`. The passthrough bootstrap safeguard is handled by 06-03.

Verify that the `BootstrapResult` interface doesn't need new fields. If `pinch-intervene` or `pinch-mute` tools only need `connectionStore` and `activityFeed` (already in BootstrapResult), no changes needed. Do NOT modify `cli.ts` here -- 06-03 owns that file in this wave.

**Step 2: Update `skill/src/index.ts`:**

Export `computeEntryHash` from `activity-feed.ts` so the audit verification tool can import it:
```typescript
export { ActivityFeed, computeEntryHash } from "./autonomy/activity-feed.js";
```

**Step 3: Update `skill/SKILL.md`:**

Read the existing SKILL.md, then add the 5 new Phase 6 tools to the tools section:

```markdown
### pinch_activity
Query the activity feed for events across all connections or filtered by specific criteria.
- `--connection <address>` — Filter by specific connection
- `--type <event_type>` — Filter by event type (message_sent, connection_approve, autonomy_change, etc.)
- `--since <ISO_timestamp>` — Events after this time
- `--until <ISO_timestamp>` — Events before this time
- `--limit <number>` — Maximum events to return (default: 50)

### pinch_intervene
Enter or exit human passthrough mode for a connection, or send a human-attributed message.
- `--start --connection <address>` — Enter passthrough mode (human takes over)
- `--stop --connection <address>` — Exit passthrough mode (hand back to agent)
- `--send --connection <address> --body <text>` — Send a message attributed to the human

### pinch_mute
Silently mute or unmute a connection. Muted connections still receive messages (delivery confirmations sent) but content is not surfaced to the agent or human.
- `--connection <address>` — Mute a connection
- `--unmute --connection <address>` — Unmute a connection

### pinch_audit_verify
Verify the integrity of the tamper-evident audit log hash chain.
- `--tail <N>` — Only verify the most recent N entries (default: all)

### pinch_audit_export
Export the audit log to a JSON file for independent verification.
- `--output <path>` — Output file path (required)
- `--since <ISO_timestamp>` — Export entries after this time
- `--until <ISO_timestamp>` — Export entries before this time
```

Also update the description/overview section to mention Phase 6 capabilities: activity feed, human intervention, audit logging, muting.

**Step 4: Update `skill/HEARTBEAT.md`:**

Read the existing HEARTBEAT.md, then add a new checklist item for audit chain health:

```markdown
### Audit Chain Health
- [ ] Run `pinch_audit_verify` — hash chain integrity check
- [ ] Check for any connections in passthrough mode that may need handback
```

And update any existing sections that reference the activity feed to note the evolved unified event log.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && npx vitest run skill/src/tools/pinch-audit-verify.test.ts skill/src/tools/pinch-audit-export.test.ts</automated>
    <manual>After 06-03 completes, run `npx vitest run skill/src/` for the full suite as a final integration check.</manual>
  </verify>
  <done>Bootstrap requires no changes (ActivityFeed evolves in-place). computeEntryHash exported from index.ts. SKILL.md documents all 5 new Phase 6 tools. HEARTBEAT.md includes audit chain health check. Tests for this plan's files pass.</done>
</task>

</tasks>

<verification>
1. pinch_audit_verify correctly detects valid chains and reports broken chains
2. pinch_audit_export produces valid JSON with all audit fields
3. SKILL.md includes documentation for all new tools
4. HEARTBEAT.md includes audit chain health check
5. Full test suite passes: `npx vitest run skill/src/`
6. No regressions in any existing functionality
</verification>

<success_criteria>
- pinch_audit_verify walks hash chain and reports pass/fail with details
- pinch_audit_export dumps audit log to JSON with optional time range filter
- SKILL.md documents: pinch_activity, pinch_intervene, pinch_mute, pinch_audit_verify, pinch_audit_export
- HEARTBEAT.md includes audit chain integrity check
- computeEntryHash exported for reuse
- All tests pass across the entire skill/src/ tree
</success_criteria>

<output>
After completion, create `.planning/phases/06-oversight-and-safety/06-04-SUMMARY.md`
</output>
