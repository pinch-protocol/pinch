---
phase: 07-wire-cli-tools-and-persist-attribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skill/package.json
  - skill/src/message-store.ts
  - skill/src/message-manager.ts
  - skill/src/tools/pinch-history.ts
  - skill/SKILL.md
autonomous: true
requirements:
  - OVRS-01
  - OVRS-02
  - OVRS-03
  - OVRS-04
  - OVRS-05
  - CONN-05

must_haves:
  truths:
    - "All 5 Phase 6 CLI tools (pinch-activity, pinch-intervene, pinch-mute, pinch-audit-verify, pinch-audit-export) are invocable as commands after pnpm install"
    - "Inbound messages with attribution (agent/human) have their attribution persisted to the messages SQLite table"
    - "Outbound messages have attribution persisted (defaulting to agent when not specified)"
    - "pinch-history output includes an attribution field for messages that have one"
  artifacts:
    - path: "skill/package.json"
      provides: "12 bin entries (7 existing + 5 new Phase 6 tools)"
      contains: "pinch-activity"
    - path: "skill/src/message-store.ts"
      provides: "Messages table with attribution column, MessageRecord with attribution field"
      contains: "attribution"
    - path: "skill/src/message-manager.ts"
      provides: "Attribution persistence in both handleIncomingMessage and sendMessage"
      contains: "attribution"
    - path: "skill/src/tools/pinch-history.ts"
      provides: "Attribution surfaced in output"
      contains: "attribution"
    - path: "skill/SKILL.md"
      provides: "Updated pinch_history example showing attribution field"
      contains: "attribution"
  key_links:
    - from: "skill/package.json"
      to: "./dist/tools/pinch-activity.js"
      via: "bin entry mapping"
      pattern: "pinch-activity.*dist/tools/pinch-activity"
    - from: "skill/src/message-manager.ts"
      to: "skill/src/message-store.ts"
      via: "saveMessage call with attribution parameter"
      pattern: "attribution.*saveMessage"
    - from: "skill/src/tools/pinch-history.ts"
      to: "skill/src/message-store.ts"
      via: "getHistory returns MessageRecord with attribution"
      pattern: "attribution"
---

<objective>
Close all remaining v1.0 audit gaps: wire Phase 6 CLI tools into package.json bin entries so they are invocable after `pnpm install`, and persist inbound/outbound message attribution to the SQLite messages table so `pinch-history` can surface whether a message was sent by an agent or a human.

Purpose: Phase 6 built 5 fully-functional CLI tools and implemented attribution on the wire, but the tools lack bin entries and attribution is discarded before persistence. This plan completes the wiring.

Output: Updated package.json with 12 bin entries, messages table with attribution column, attribution persisted in both message directions, pinch-history surfacing attribution.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-wire-cli-tools-and-persist-attribution/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 6 bin entries to package.json and verify build</name>
  <files>skill/package.json</files>
  <action>
Add 5 new bin entries to skill/package.json for the Phase 6 CLI tools. The existing bin object has 7 entries. Add these 5 after the existing entries:

```json
"pinch-activity": "./dist/tools/pinch-activity.js",
"pinch-intervene": "./dist/tools/pinch-intervene.js",
"pinch-mute": "./dist/tools/pinch-mute.js",
"pinch-audit-verify": "./dist/tools/pinch-audit-verify.js",
"pinch-audit-export": "./dist/tools/pinch-audit-export.js"
```

After editing package.json:
1. Run `pnpm --filter @pinch/skill build` to compile TypeScript to dist/
2. Run `pnpm install` from workspace root to wire up the new bin entries
3. Verify each tool is invocable: run `npx pinch-activity --help` (or just invoke it -- it should show usage, not "command not found")

Do NOT modify any TypeScript source files in this task. The tools already exist and compile correctly.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && pnpm --filter @pinch/skill build && ls skill/dist/tools/pinch-activity.js skill/dist/tools/pinch-intervene.js skill/dist/tools/pinch-mute.js skill/dist/tools/pinch-audit-verify.js skill/dist/tools/pinch-audit-export.js</automated>
    <manual>All 5 dist files exist after build</manual>
  </verify>
  <done>skill/package.json has 12 bin entries (7 existing + 5 new). TypeScript compiles. All 5 new dist/tools/*.js files exist.</done>
</task>

<task type="auto">
  <name>Task 2: Persist message attribution to SQLite and surface in pinch-history</name>
  <files>skill/src/message-store.ts, skill/src/message-manager.ts, skill/src/tools/pinch-history.ts, skill/SKILL.md</files>
  <action>
Four files need changes. Follow the exact patterns from RESEARCH.md.

**1. skill/src/message-store.ts:**

a) Add `attribution` to the `MessageRecord` interface as an optional field:
```typescript
attribution?: "agent" | "human";
```
Place it after the `failureReason` field, before `createdAt`.

b) In `initSchema()`, after the existing `CREATE TABLE IF NOT EXISTS messages` and index statements, add schema evolution using the established PRAGMA table_info pattern (same pattern used in activity-feed.ts):
```typescript
const columns = this.db
    .prepare("PRAGMA table_info(messages)")
    .all() as { name: string }[];
const columnNames = new Set(columns.map((c) => c.name));

if (!columnNames.has("attribution")) {
    this.db.exec(
        "ALTER TABLE messages ADD COLUMN attribution TEXT",
    );
}
```

c) In `saveMessage()`, add `attribution` to the INSERT statement's column list and values. Use `record.attribution ?? null` for the parameter value.

d) In `rowToRecord()` (the private method mapping SQLite rows to MessageRecord), add:
```typescript
attribution: (row.attribution as string as "agent" | "human") ?? undefined,
```
This ensures the field only appears on the record when a value exists in the database.

**2. skill/src/message-manager.ts:**

a) In `handleIncomingMessage()`, find where `messageRecord` is constructed (after extracting `body` and `inboundAttribution` from the x-pinch+json wrapper). Add `attribution: inboundAttribution` to the messageRecord object before the `saveMessage()` call. The `inboundAttribution` variable already exists -- it is extracted at line ~217-227 but currently discarded.

b) In `sendMessage()`, find where the outbound message record is saved via `saveMessage()`. Add `attribution: params.attribution ?? "agent"` to the record. The `params.attribution` field already exists on `SendMessageParams` -- it just is not being persisted.

**3. skill/src/tools/pinch-history.ts:**

In the `run()` function, find where messages are mapped to the output JSON object. Add `attribution: m.attribution ?? null` to the output mapping. This ensures attribution appears in the JSON output as either `"agent"`, `"human"`, or `null` (for old messages without attribution).

**4. skill/SKILL.md:**

Find the `pinch_history` section's example JSON output (around line 148-161). Add `"attribution": "agent"` (or `null`) to the example message object, placed after the `"state"` field.

**Important:**
- The `attribution` column MUST be nullable TEXT (not NOT NULL) -- existing messages have no attribution.
- The PRAGMA table_info guard MUST be present for idempotent schema evolution.
- Do NOT modify the activity_events table or hash chain -- attribution is only on the messages table.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch && pnpm --filter @pinch/skill build && pnpm --filter @pinch/skill test</automated>
    <manual>Existing tests pass. MessageRecord interface includes attribution. saveMessage persists attribution. rowToRecord maps attribution. pinch-history output includes attribution field.</manual>
  </verify>
  <done>Messages table has attribution column (nullable TEXT). MessageRecord interface includes optional attribution field. handleIncomingMessage persists inbound attribution. sendMessage persists outbound attribution (default "agent"). pinch-history surfaces attribution. SKILL.md example updated. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @pinch/skill build` succeeds (TypeScript compiles with new interface field)
2. `pnpm --filter @pinch/skill test` passes (all existing tests green, no regressions)
3. All 5 Phase 6 dist files exist: `ls skill/dist/tools/pinch-{activity,intervene,mute,audit-verify,audit-export}.js`
4. skill/package.json bin field has 12 entries
5. MessageRecord interface includes `attribution?: "agent" | "human"`
6. message-store.ts initSchema() has PRAGMA table_info guard for attribution column
7. message-manager.ts handleIncomingMessage persists inboundAttribution
8. message-manager.ts sendMessage persists attribution (defaults to "agent")
9. pinch-history.ts output mapping includes attribution field
10. SKILL.md pinch_history example shows attribution
</verification>

<success_criteria>
- All 12 bin entries present in skill/package.json
- `pnpm --filter @pinch/skill build` succeeds
- `pnpm --filter @pinch/skill test` passes with zero failures
- Attribution column exists in messages table schema evolution
- Both inbound and outbound message paths persist attribution to SQLite
- pinch-history tool surfaces attribution in output
</success_criteria>

<output>
After completion, create `.planning/phases/07-wire-cli-tools-and-persist-attribution/07-01-SUMMARY.md`
</output>
