---
phase: 09-skill-documentation-and-cli-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skill/src/tools/cli.ts
  - skill/src/tools/pinch-permissions.ts
  - skill/src/tools/pinch-audit-verify.ts
  - skill/src/tools/pinch-audit-export.ts
autonomous: true
requirements:
  - CLEANUP-09

must_haves:
  truths:
    - "pinch-permissions runs without PINCH_RELAY_URL set and without a relay server"
    - "pinch-audit-verify runs without PINCH_RELAY_URL set and without a relay server"
    - "pinch-audit-export runs without PINCH_RELAY_URL set and without a relay server"
    - "Existing relay-dependent tools (pinch-send, pinch-connect, pinch-intervene) still work via bootstrap()"
  artifacts:
    - path: "skill/src/tools/cli.ts"
      provides: "bootstrapLocal() and shutdownLocal() functions for relay-free CLI operation"
      exports: ["bootstrapLocal", "shutdownLocal", "LocalBootstrapResult"]
    - path: "skill/src/tools/pinch-permissions.ts"
      provides: "Permissions tool using bootstrapLocal()"
      contains: "bootstrapLocal"
    - path: "skill/src/tools/pinch-audit-verify.ts"
      provides: "Audit verify tool using bootstrapLocal()"
      contains: "bootstrapLocal"
    - path: "skill/src/tools/pinch-audit-export.ts"
      provides: "Audit export tool using bootstrapLocal()"
      contains: "bootstrapLocal"
  key_links:
    - from: "skill/src/tools/pinch-permissions.ts"
      to: "skill/src/tools/cli.ts"
      via: "import { bootstrapLocal, shutdownLocal }"
      pattern: "bootstrapLocal"
    - from: "skill/src/tools/pinch-audit-verify.ts"
      to: "skill/src/tools/cli.ts"
      via: "import { bootstrapLocal, shutdownLocal }"
      pattern: "bootstrapLocal"
    - from: "skill/src/tools/pinch-audit-export.ts"
      to: "skill/src/tools/cli.ts"
      via: "import { bootstrapLocal, shutdownLocal }"
      pattern: "bootstrapLocal"
---

<objective>
Eliminate unnecessary relay WebSocket connections in three local-only CLI tools by adding a `bootstrapLocal()` function to the shared CLI module.

Purpose: `pinch-permissions`, `pinch-audit-verify`, and `pinch-audit-export` only need local data stores (ConnectionStore JSON, MessageStore SQLite). Currently they call `bootstrap()` which unconditionally opens a relay WebSocket, making them slow to start and fail when the relay is unreachable. This refactor adds `bootstrapLocal()` that initializes only local stores, then updates the three tools to use it.

Note: Success criterion #1 (SKILL.md tier name correction) is already satisfied per research -- commit `ac386ab` already fixed the names. No work needed for that criterion.

Output: Updated `cli.ts` with `bootstrapLocal()`/`shutdownLocal()`, three updated CLI tools, passing tests.
</objective>

<execution_context>
@/Users/riecekeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riecekeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-skill-documentation-and-cli-optimization/09-RESEARCH.md
@skill/src/tools/cli.ts
@skill/src/tools/pinch-permissions.ts
@skill/src/tools/pinch-audit-verify.ts
@skill/src/tools/pinch-audit-export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bootstrapLocal() and shutdownLocal() to cli.ts</name>
  <files>skill/src/tools/cli.ts</files>
  <action>
Add a `LocalBootstrapResult` interface and two new exported functions to `skill/src/tools/cli.ts`:

1. **`LocalBootstrapResult` interface** with exactly these fields:
   - `keypair: Keypair`
   - `connectionStore: ConnectionStore`
   - `messageStore: MessageStore`
   - `activityFeed: ActivityFeed`

2. **`bootstrapLocal()` async function** that:
   - Uses a separate singleton `let localBootstrapped: LocalBootstrapResult | null = null` (NOT the existing `bootstrapped` variable)
   - Returns early if `localBootstrapped` is already set (same singleton pattern as `bootstrap()`)
   - Reads `PINCH_KEYPAIR_PATH` (default: `~/.pinch/keypair.json`) and `PINCH_DATA_DIR` (default: `~/.pinch/data`) -- same env vars as `bootstrap()`
   - Does NOT read or require `PINCH_RELAY_URL` -- this is the key difference
   - Loads or generates keypair (same logic as `bootstrap()`)
   - Creates `ConnectionStore`, calls `load()` and `clearPassthroughFlags()`
   - Creates `MessageStore`
   - Creates `ActivityFeed` from `messageStore.getDb()`
   - Does NOT create RelayClient, ConnectionManager, MessageManager, InboundRouter, PermissionsEnforcer, CircuitBreaker, EnforcementPipeline, or any relay-dependent component
   - Returns `LocalBootstrapResult`

3. **`shutdownLocal()` async function** that:
   - Returns early if `localBootstrapped` is null
   - Calls `localBootstrapped.messageStore.close()`
   - Sets `localBootstrapped = null`

Keep existing `bootstrap()`, `shutdown()`, `BootstrapResult`, and all their imports unchanged. The new functions are purely additive.

Place the new interface, singleton, and functions AFTER the existing `shutdown()` function to keep the file logically organized (full bootstrap first, local bootstrap second).
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch/skill && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify cli.ts exports bootstrapLocal, shutdownLocal, and LocalBootstrapResult</manual>
  </verify>
  <done>cli.ts has bootstrapLocal() and shutdownLocal() functions that initialize only local stores without requiring PINCH_RELAY_URL or creating a RelayClient. Existing bootstrap()/shutdown() unchanged. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update three local-only CLI tools to use bootstrapLocal()</name>
  <files>
    skill/src/tools/pinch-permissions.ts
    skill/src/tools/pinch-audit-verify.ts
    skill/src/tools/pinch-audit-export.ts
  </files>
  <action>
Update each of the three CLI tools to use `bootstrapLocal()` and `shutdownLocal()` instead of `bootstrap()` and `shutdown()`:

**pinch-permissions.ts:**
- Change import from `import { bootstrap, shutdown } from "./cli.js"` to `import { bootstrapLocal, shutdownLocal } from "./cli.js"`
- Line 176: `const { connectionStore } = await bootstrap()` becomes `const { connectionStore } = await bootstrapLocal()`
- Lines 183, 198, 270: `await shutdown()` becomes `await shutdownLocal()` (all three occurrences)

**pinch-audit-verify.ts:**
- Change import from `import { bootstrap, shutdown } from "./cli.js"` to `import { bootstrapLocal, shutdownLocal } from "./cli.js"`
- Line 50: `const { messageStore } = await bootstrap()` becomes `const { messageStore } = await bootstrapLocal()`
- Lines 71, 139, 157, 175, 188: `await shutdown()` becomes `await shutdownLocal()` (all five occurrences)

**pinch-audit-export.ts:**
- Change import from `import { bootstrap, shutdown } from "./cli.js"` to `import { bootstrapLocal, shutdownLocal } from "./cli.js"`
- Line 57: `const { messageStore } = await bootstrap()` becomes `const { messageStore } = await bootstrapLocal()`
- Line 117: `await shutdown()` becomes `await shutdownLocal()` (one occurrence)

No other changes needed. The tools' logic, argument parsing, and output format remain identical.
  </action>
  <verify>
    <automated>cd /Users/riecekeck/Coding/Pinch/skill && npx tsc --noEmit 2>&1 | head -20 && npx vitest run src/tools/pinch-permissions.test.ts src/tools/pinch-audit-verify.test.ts src/tools/pinch-audit-export.test.ts 2>&1 | tail -30</automated>
    <manual>Verify that running pinch-permissions --help (without PINCH_RELAY_URL set) does not attempt a WebSocket connection</manual>
  </verify>
  <done>All three CLI tools use bootstrapLocal()/shutdownLocal(). They no longer require PINCH_RELAY_URL or a running relay server. TypeScript compiles without errors. Existing tests pass.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd skill && npx tsc --noEmit` passes with zero errors
2. Existing tests pass: `cd skill && npx vitest run` -- all test suites pass
3. Local-only behavior: The three updated tools do NOT import `bootstrap` or `shutdown` from `cli.js` (only `bootstrapLocal`/`shutdownLocal`)
4. No regression: Other tools (pinch-send, pinch-connect, pinch-intervene, etc.) still import and use `bootstrap`/`shutdown` unchanged
</verification>

<success_criteria>
- `bootstrapLocal()` and `shutdownLocal()` exported from `skill/src/tools/cli.ts`
- `pinch-permissions`, `pinch-audit-verify`, and `pinch-audit-export` use `bootstrapLocal()`/`shutdownLocal()` exclusively
- All existing tests pass
- No tool imports both `bootstrap` and `bootstrapLocal` (clean separation)
</success_criteria>

<output>
After completion, create `.planning/phases/09-skill-documentation-and-cli-optimization/09-01-SUMMARY.md`
</output>
